<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Filedash - File Manager Dashboard</title>

	<!-- Favicon -->
	<link rel="shortcut icon" href="assets/media/image/favicon.png" />

	<!-- Main css -->
	<link rel="stylesheet" href="vendors/bundle.css" type="text/css">

	<link href="css/css2.css" rel="stylesheet">

	<!-- Prism -->
	<link rel="stylesheet" href="vendors/prism/prism.css" type="text/css">


	<!-- App css -->
	<link rel="stylesheet" href="assets/css/app.css" type="text/css">

	<!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->
</head>
<body>
<!-- Preloader -->
<div class="preloader">
	<div class="preloader-icon"></div>
</div>
<!-- ./ Preloader -->

<!-- Layout wrapper -->
<div class="layout-wrapper">
	<!-- Header -->
	<div id="header"></div>


	<div class="content-wrapper">

		<div id="nav"></div>


		<!-- Content body -->
		<div class="content-body">

			<!-- 数据源创建页面 -->
			<div id="createdts" class="content" style="display: none;">
				<div class="page-header d-flex justify-content-between">
					<h2 id="title">创建数据源</h2>
					<a href="#" class="components-toggler">
						<i class="ti-menu"></i>
					</a>
				</div>

				<div class="row">

					<div class="col-xl-7 components-sidebar">
						<form id="dtsform" onsubmit="return false" class="needs-validation" novalidate>
							<label for="dataSourceName">数据源名称</label>
							<input type="text" class="form-control" id="dataSourceName" placeholder="请输入数据源名称" required>
							<div class="valid-feedback">
							</div>
							<div class="invalid-feedback">
								请输入数据源名称
							</div>
							<label for="dataSourceType">数据源类型</label>
							<select class="custom-select" id="dataSourceType" required>
								<option value="cos">腾讯云COS</option>
								<option value="oss">阿里云OSS</option>
								<option value="bos">百度云BOS</option>
								<option value="obs">华为云OBS</option>
							</select>
							<label for="accessKey">AccessKey</label>
							<input type="text" class="form-control" id="accessKey" placeholder="请输入AccessKey" required>
							<div class="valid-feedback">
							</div>
							<div class="invalid-feedback">
								请输入AccessKey
							</div>
							<label for="accessSecret">AccessSecret</label>
							<input type="text" class="form-control" id="accessSecret" placeholder="请输入AccessSecret" required>
							<div class="valid-feedback">
							</div>
							<div class="invalid-feedback">
								请输入AccessSecret
							</div>
							<label for="region">地域</label>
							<input type="text" class="form-control" id="region" placeholder="请输入地域" required>
							<div class="valid-feedback">
							</div>
							<div class="invalid-feedback">
								请输入地域
							</div>

							<div style="margin-top: 20px;">
								<button class="btn btn-primary" id="create">确定</button>
								<button class="btn btn-primary" style="display: none;" id="update">确定</button>
								<button type="submit" style="margin-left: 20px;" class="btn btn-success" id="test">测试
								</button>
								<button type="button" style="margin-left: 20px;" class="btn btn-success" id="quit">取消
								</button>
							</div>
						</form>

					</div>
					<div class="col-xl-3"></div>
				</div>
			</div>

			<!-- 数据源展示列表 -->
			<div id="listdts" class="content">
				<div class="row" style="margin-bottom: 10px;">
					<div class="col-xl-12 ">
						<button id="toCreate" class="btn btn-primary pull-right">创建</button>
					</div>
				</div>


				<div class="row">
					<div class="col-xl-12 components-sidebar">
						<table class="table">
							<thead>
							<tr>
								<th scope="col">序号</th>
								<th scope="col">数据源名称</th>
								<th scope="col">数据源类型</th>
								<th scope="col">创建时间</th>
								<th scope="col">操作</th>
							</tr>
							</thead>
							<tbody id="dtsource">
							</tbody>
						</table>


					</div>


					<!-- Sidebar group -->
					<div id="sidebar"></div>
				</div>
				<!-- ./ Content wrapper -->
			</div>
			<div class="modal fade" id="resultModal" tabindex="-1" role="dialog" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="exampleModalLabel">提示</h5>
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">×</span>
							</button>
						</div>
						<div id="resultMessgae" style="font-size: 20px;font-weight: 900;" class="modal-body">

						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-dismiss="modal">确定</button>
						</div>
					</div>
				</div>
			</div>
			<!-- ./ Layout wrapper -->

			<!-- Main scripts -->
			<script src="vendors/bundle.js"></script>
			<script src="js/raphael-min.js"></script>
			<script src="js/justgage.min.js"></script>

			<!-- Prism -->
			<script src="vendors/prism/prism.js"></script>
			<script src="https://cdn.jsdelivr.net/gh/WendyBoys/oss/js/axios.min.js"></script>
			<script src="https://cdn.jsdelivr.net/gh/WendyBoys/oss/js/jquery.cookie.js"></script>
			<!-- App scripts -->
			<script src="assets/js/app.js"></script>
</body>
</html>

<script>
	$("#header").load("header.html");
	$("#nav").load("nav.html");
	$("#sidebar").load("sidebar.html");
	var token = $.cookie('token');
	if (token == undefined || token.trim() == '') {
		alert('登录失效，请重新登录');
		window.location.href = "login.html";
	}
	fentch();
	var currentdtsid;

	function fentch() {
		var $table = $("#dtsource");
		$table.empty();
		axios.get('http://localhost/dtsource/findAll?token=' + token).then((response) => {
			var result = response.data.message;
			var data = response.data.data;
			var index = 1;
			if (result == 'Success') {
				for (i = 0; i < data.length; i++) {
					var $tr = $("<tr>" +
							"<td>" + index++ + "</td>" +
							"<td>" + "<a href='javascript:updatedts(" + data[i].id +
							")' style='color: #007bff;'>" + data[i].dtSourceName + "</a></td>" +
							"<td>" + data[i].dtSourceType + "</td>" +
							"<td>" + data[i].createTime + "</td>" +
							"<td><a href='javascript:testdts(" + data[i].id +
							")' style='color: #007bff;'>测试</a> &nbsp;<a href='javascript:deletedts(" + data[i].id +
							")' style='color: #007bff;'>删除</a></td>" +
							"</tr>");
					$table.append($tr);
				}

			} else {

			}
		});

	}


	function updatedts(id) {
		$("#title").text('修改数据源');
		$("#listdts").css('display', 'none');
		$("#createdts").css('display', '');
		$('#create').css('display', 'none');
		$('#update').css('display', '');
		currentdtsid = id;
		axios.get('http://localhost/dtsource/getDtSourceById?id=' + id).then((response) => {
			var result = response.data.message;
			var data = response.data.data;
			var dtSourceJson = jQuery.parseJSON(data.dtSourceJson);
			if (result == 'Success') {
				$('#dataSourceName').val(data.dtSourceName);
				$('#dataSourceType').val(data.dtSourceType);
				$('#accessKey').val(dtSourceJson.accessKey);
				$('#accessSecret').val(dtSourceJson.accessSecret);
				$('#region').val(dtSourceJson.region);
			} else {
				alert('操作失败，请重试');
			}
		});
	}


	$('#update').click(function() {
		var dataSourceName = $('#dataSourceName').val();
		var dataSourceType = $('#dataSourceType').val();
		var accessKey = $('#accessKey').val();
		var accessSecret = $('#accessSecret').val();
		var region = $('#region').val();
		if (dataSourceName == undefined || dataSourceName.trim() == '') {
			return true;
		} else if (dataSourceType == undefined || dataSourceType.trim() == '') {
			return true;
		} else if (accessKey == undefined || accessKey.trim() == '') {
			return true;
		} else if (accessSecret == undefined || accessSecret.trim() == '') {
			return true;
		} else if (region == undefined || region.trim() == '') {
			return true;
		}
		axios.post('http://localhost/dtsource/update', {
			id: currentdtsid,
			dataSourceName: dataSourceName,
			dataSourceType: dataSourceType,
			secretId: accessKey,
			secretKey: accessSecret,
			region: region,
		}).then((response) => {
			var result = response.data.message;
			if (result == 'Success') {
				$("#listdts").css('display', '');
				$("#createdts").css('display', 'none');
				window.location.href = 'datasource.html'
			} else {
				alert('修改失败');
			}
		});
	})



	function testdts(id) {
		axios.post('http://localhost/dtsource/connection', {
			id: id,
		}).then((response) => {
			var result = response.data.message;
			if (result == 'Success') {
				$('#resultMessgae').text('连接成功 └(^o^)┘').css({
					color: 'green'
				});
				$('#resultModal').modal('show');
			} else {
				$('#resultMessgae').text('连接失败X﹏X').css({
					color: 'red'
				})
				$('#resultModal').modal('show');
			}
		});
	}

	function deletedts(id) {
		//发删除请求
		axios.delete('http://localhost/dtsource/delete', {
			data: {
				id: id,
			}
		}).then((response) => {
			var result = response.data.message;
			if (result == 'Success') {
				$('#resultMessgae').text('删除成功 └(^o^)┘').css({
					color: 'green'
				});
				$('#resultModal').modal('show');
				fentch();
			} else {
				$('#resultMessgae').text('删除失败X﹏X').css({
					color: 'red'
				})
				$('#resultModal').modal('show');
			}
		});
	}

	$('#toCreate').click(function() {
		$("#listdts").css('display', 'none');
		$("#createdts").css('display', '');
	});

	$('#quit').click(function() {
		$("#listdts").css('display', '');
		$("#createdts").css('display', 'none');
	});


	(function() {
		'use strict';
		window.addEventListener('load', function() {
			var forms = document.getElementsByClassName('needs-validation');
			var validation = Array.prototype.filter.call(forms, function(form) {
				form.addEventListener('submit', function(event) {
					if (form.checkValidity() === false) {
						event.preventDefault();
						event.stopPropagation();
					}
					form.classList.add('was-validated');
				}, false);
			});
		}, false);
	})();

	$('#create').click(function() {
		var dataSourceName = $('#dataSourceName').val();
		var dataSourceType = $('#dataSourceType').val();
		var accessKey = $('#accessKey').val();
		var accessSecret = $('#accessSecret').val();
		var region = $('#region').val();
		if (dataSourceName == undefined || dataSourceName.trim() == '') {
			return true;
		} else if (dataSourceType == undefined || dataSourceType.trim() == '') {
			return true;
		} else if (accessKey == undefined || accessKey.trim() == '') {
			return true;
		} else if (accessSecret == undefined || accessSecret.trim() == '') {
			return true;
		} else if (region == undefined || region.trim() == '') {
			return true;
		}
		axios.post('http://localhost/dtsource/create', {
			token: token,
			dataSourceName: dataSourceName,
			dataSourceType: dataSourceType,
			secretId: accessKey,
			secretKey: accessSecret,
			region: region,
		}).then((response) => {
			var result = response.data.message;
			if (result == 'Success') {
				$("#listdts").css('display', '');
				$("#createdts").css('display', 'none');
				window.location.href = 'datasource.html'
			} else {
				alert(response.data.data);
			}
		});

	});


	$('#test').click(function() {
		var dataSourceName = $('#dataSourceName').val();
		var dataSourceType = $('#dataSourceType').val();
		var accessKey = $('#accessKey').val();
		var accessSecret = $('#accessSecret').val();
		var region = $('#region').val();

		if (dataSourceName == undefined || dataSourceName.trim() == '') {
			return true;
		} else if (dataSourceType == undefined || dataSourceType.trim() == '') {
			return true;
		} else if (accessKey == undefined || accessKey.trim() == '') {
			return true;
		} else if (accessSecret == undefined || accessSecret.trim() == '') {
			return true;
		} else if (region == undefined || region.trim() == '') {
			return true;
		}
		axios.post('http://localhost/dtsource/testconnection', {
			secretId: accessKey,
			secretKey: accessSecret,
			region: region,
		}).then((response) => {
			var result = response.data.message;
			if (result == 'Success') {
				$('#resultMessgae').text('连接成功 └(^o^)┘').css({
					color: 'green'
				});
				$('#resultModal').modal('show');
			} else {
				$('#resultMessgae').text('连接失败X﹏X').css({
					color: 'red'
				})
				$('#resultModal').modal('show');
			}
		});
	})
</script>
