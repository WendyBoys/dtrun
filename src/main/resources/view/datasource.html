<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<title>Filedash - File Manager Dashboard</title>

		<!-- Favicon -->
		<link rel="shortcut icon" href="assets/media/image/favicon.png" />

		<!-- Main css -->
		<link rel="stylesheet" href="vendors/bundle.css" type="text/css">

		<link href="css/css2.css" rel="stylesheet">

		<!-- Prism -->
		<link rel="stylesheet" href="vendors/prism/prism.css" type="text/css">


		<!-- App css -->
		<link rel="stylesheet" href="assets/css/app.css" type="text/css">

		<!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->
	</head>
	<body>
		<!-- Preloader -->
		<div class="preloader">
			<div class="preloader-icon"></div>
		</div>
		<!-- ./ Preloader -->

		<!-- Layout wrapper -->
		<div class="layout-wrapper">
			<!-- Header -->
			<div class="header d-print-none">
				<div class="header-container">
					<div class="header-body">
						<div class="header-body-left">
							<ul class="navbar-nav">
								<li class="nav-item navigation-toggler">
									<a href="#" class="nav-link">
										<i class="ti-menu"></i>
									</a>
								</li>
								<li class="nav-item">
									<div class="header-search-form">
										<form>
											<div class="input-group">
												<div class="input-group-prepend">
													<button class="btn">
														<i class="ti-search"></i>
													</button>
												</div>
												<input type="text" id="search" class="form-control" placeholder="Search something...">
												<div class="input-group-append">
													<button class="btn header-search-close-btn">
														<i data-feather="x"></i>
													</button>
												</div>
											</div>
										</form>
									</div>
								</li>
							</ul>
						</div>

						<div class="header-body-right">
							<ul class="navbar-nav">
								<li class="nav-item">
									<a href="#" class="nav-link mobile-header-search-btn" title="Search">
										<i class="ti-search"></i>
									</a>
								</li>
								<li class="nav-item">
									<a href="#" class="nav-link" title="Dark">
										<i class="fa fa-moon-o"></i>
									</a>
								</li>

								<li class="nav-item dropdown">
									<a href="#" class="nav-link nav-link-notify" title="Notifications" data-toggle="dropdown">
										<i class="ti-bell"></i>
									</a>
									<div class="dropdown-menu dropdown-menu-right dropdown-menu-big">
										<div class="bg-primary px-3 py-3">
											<h6 class="mb-0">Notifications</h6>
										</div>
										<div class="dropdown-scroll">
											<ul class="list-group list-group-flush">
												<li>
													<a href="#" class="list-group-item d-flex hide-show-toggler">
														<div>
															<figure class="avatar mr-3">
																<span class="avatar-title bg-secondary-bright text-secondary rounded-circle">
																	<i class="ti-server"></i>
																</span>
															</figure>
														</div>
														<div class="flex-grow-1">
															<p class="mb-0">
																Your storage space is running low!
																<i title="Mark as unread" data-toggle="tooltip" class="hide-show-toggler-item fa fa-check font-size-11 position-absolute right-0 top-0 mr-3 mt-3"></i>
															</p>
															<span class="text-muted small">4 sec ago</span>
														</div>
													</a>
												</li>
												<li>
													<a href="#" class="list-group-item d-flex hide-show-toggler">
														<div>
															<figure class="avatar mr-3">
																<img src="assets/media/image/user/man_avatar4.jpg" class="rounded-circle" alt="avatar">
															</figure>
														</div>
														<div>
															<p class="mb-0">
																<span class="text-primary">Jonny Richie</span> uploaded new
																files
																<i title="Mark as read" data-toggle="tooltip" class="hide-show-toggler-item fa fa-circle-o font-size-11 position-absolute right-0 top-0 mr-3 mt-3"></i>
															</p>
															<span class="text-muted small">20 min ago</span>
														</div>
													</a>
												</li>
												<li class="text-divider text-center small pb-2 px-3">
													<span>Old notifications</span>
												</li>
												<li>
													<a href="#" class="list-group-item d-flex hide-show-toggler">
														<div>
															<figure class="avatar mr-3">
																<span class="avatar-title bg-info-bright text-info rounded-circle">
																	<i class="fa fa-cloud-upload"></i>
																</span>
															</figure>
														</div>
														<div class="flex-grow-1">
															<p class="mb-0">
																Upgrade plan
																<i title="Mark as unread" data-toggle="tooltip" class="hide-show-toggler-item fa fa-check font-size-11 position-absolute right-0 top-0 mr-3 mt-3"></i>
															</p>
															<span class="text-muted small">45 sec ago</span>
														</div>
													</a>
												</li>
												<li>
													<a href="#" class="list-group-item d-flex hide-show-toggler">
														<div>
															<figure class="avatar mr-3">
																<span class="avatar-title bg-success-bright text-success rounded-circle">
																	<i class="ti-share"></i>
																</span>
															</figure>
														</div>
														<div class="flex-grow-1">
															<p class="mb-0">
																A file has been shared
																<i title="Mark as unread" data-toggle="tooltip" class="hide-show-toggler-item fa fa-check font-size-11 position-absolute right-0 top-0 mr-3 mt-3"></i>
															</p>
															<span class="text-muted small">58 sec ago</span>
														</div>
													</a>
												</li>
											</ul>
										</div>
										<div class="px-3 py-2 text-right border-top">
											<ul class="list-inline small">
												<li class="list-inline-item mb-0">
													<a href="#">Mark All Read</a>
												</li>
											</ul>
										</div>
									</div>
								</li>

								<li class="nav-item dropdown">
									<a href="#" class="nav-link" title="Settings" data-sidebar-target="#settings">
										<i class="ti-settings"></i>
									</a>
								</li>

								<li class="nav-item dropdown">
									<a href="#" class="nav-link profile-nav-link dropdown-toggle" title="User menu" data-toggle="dropdown">
										<span class="mr-2 d-sm-inline d-none username"></span>
										<figure class="avatar avatar-sm">
											<img src="assets/media/image/user/man_avatar3.jpg" class="rounded-circle" alt="avatar">
										</figure>
									</a>
									<div class="dropdown-menu dropdown-menu-right dropdown-menu-big">
										<div class="text-center py-4" data-background-image="assets/media/image/image1.jpg">
											<figure class="avatar avatar-lg mb-3 border-0">
												<img src="assets/media/image/user/man_avatar3.jpg" class="rounded-circle" alt="image">
											</figure>
											<h5 class="mb-0 username"></h5>
										</div>
										<div class="list-group list-group-flush">
											<a href="#" class="list-group-item" data-sidebar-target="#settings">Settings</a>
											<span id="logout" style="cursor: pointer;" class="list-group-item text-danger">注销</span>
										</div>
										<div class="pb-0 p-4">
											<div class="mb-4">
												<h6 class="d-flex justify-content-between">
													Completed Tasks
													<span class="float-right">%68</span>
												</h6>
												<div class="progress" style="height:5px;">
													<div class="progress-bar bg-primary" role="progressbar" style="width: 68%;" aria-valuenow="68"
													 aria-valuemin="0" aria-valuemax="100"></div>
												</div>
											</div>
										</div>
									</div>
								</li>
							</ul>
						</div>
					</div>

					<ul class="navbar-nav ml-auto">
						<li class="nav-item header-toggler">
							<a href="#" class="nav-link">
								<i class="ti-arrow-down"></i>
							</a>
						</li>
						<li class="nav-item sidebar-toggler">
							<a href="#" class="nav-link">
								<i class="ti-cloud"></i>
							</a>
						</li>
					</ul>
				</div>
			</div>
			<!-- ./ Header -->


			<div class="content-wrapper">

				<div id="nav"></div>


				<!-- Content body -->
				<div class="content-body">




					<!-- 数据源创建页面 -->
					<div id="createdts" class="content" style="display: none;">
						<div class="page-header d-flex justify-content-between">
							<h2 id="title">创建数据源</h2>
							<a href="#" class="components-toggler">
								<i class="ti-menu"></i>
							</a>
						</div>

						<div class="row">

							<div class="col-xl-7 components-sidebar">
								<form id="dtsform" onsubmit="return false" class="needs-validation" novalidate>
									<label for="dataSourceName">数据源名称</label>
									<input type="text" class="form-control" id="dataSourceName" placeholder="请输入数据源名称" required>
									<div class="valid-feedback">
									</div>
									<div class="invalid-feedback">
										请输入数据源名称
									</div>
									<label for="dataSourceType">数据源类型</label>
									<select class="custom-select" id="dataSourceType" required>
										<option value="cos">腾讯云COS</option>
										<option value="oss">阿里云OSS</option>
										<option value="bos">百度云BOS</option>
										<option value="obs">华为云OBS</option>
									</select>
									<label for="accessKey">AccessKey</label>
									<input type="text" class="form-control" id="accessKey" placeholder="请输入AccessKey" required>
									<div class="valid-feedback">
									</div>
									<div class="invalid-feedback">
										请输入AccessKey
									</div>
									<label for="accessSecret">AccessSecret</label>
									<input type="text" class="form-control" id="accessSecret" placeholder="请输入AccessSecret" required>
									<div class="valid-feedback">
									</div>
									<div class="invalid-feedback">
										请输入AccessSecret
									</div>
									<label for="region">地域</label>
									<input type="text" class="form-control" id="region" placeholder="请输入地域" required>
									<div class="valid-feedback">
									</div>
									<div class="invalid-feedback">
										请输入地域
									</div>

									<div style="margin-top: 20px;">
										<button class="btn btn-primary" id="create">确定</button>
										<button class="btn btn-primary" style="display: none;" id="update">确定</button>
										<button type="submit" style="margin-left: 20px;" class="btn btn-success" id="test">测试
										</button>
										<button type="button" style="margin-left: 20px;" class="btn btn-success" id="quit">取消
										</button>
									</div>
								</form>

							</div>
							<div class="col-xl-3"></div>
						</div>
					</div>

					<!-- 数据源展示列表 -->
					<div id="listdts" class="content">
						<div class="row" style="margin-bottom: 10px;">
							<div class="col-xl-12 ">
								<button id="toCreate" class="btn btn-primary pull-right">创建</button>
							</div>
						</div>


						<div class="row">
							<div class="col-xl-12 components-sidebar">
								<table id="table" class="table">
									<thead>
										<tr>
											<th scope="col">序号</th>
											<th scope="col">数据源名称</th>
											<th scope="col">数据源类型</th>
											<th scope="col">创建时间</th>
											<th scope="col">操作</th>
										</tr>
									</thead>
									<tbody id="dtsource">
									</tbody>
								</table>


							</div>


							<!-- Sidebar group -->
							<div id="sidebar"></div>
						</div>
						<!-- ./ Content wrapper -->
					</div>





					<div class="modal fade" id="resultModal" tabindex="-1" role="dialog" aria-hidden="true">
						<div class="modal-dialog">
							<div class="modal-content">
								<div class="modal-header">
									<h5 class="modal-title" id="exampleModalLabel">提示</h5>
									<button type="button" class="close" data-dismiss="modal" aria-label="Close">
										<span aria-hidden="true">×</span>
									</button>
								</div>
								<div id="resultMessgae" style="font-size: 20px;font-weight: 900;" class="modal-body">

								</div>
								<div class="modal-footer">
									<button type="button" class="btn btn-secondary" data-dismiss="modal">确定</button>
								</div>
							</div>
						</div>
					</div>
					<!-- ./ Layout wrapper -->

					<!-- Main scripts -->
					<script src="vendors/bundle.js"></script>
					<script src="js/raphael-min.js"></script>
					<script src="js/justgage.min.js"></script>

					<!-- Prism -->
					<script src="vendors/prism/prism.js"></script>
					<script src="https://cdn.jsdelivr.net/gh/WendyBoys/oss/js/axios.min.js"></script>
					<script src="https://cdn.jsdelivr.net/gh/WendyBoys/oss/js/jquery.cookie.js"></script>
					<!-- App scripts -->
					<script src="assets/js/app.js"></script>
	</body>
</html>

<script>
	var token = $.cookie('token');
	if (token == undefined || token.trim() == '') {
		alert('登录过期，请重新登录');
		window.location.href = "login.html";
	}
	axios.interceptors.request.use(function(config) {
		config.headers.common['token'] = token;
		return config;
	});

	$("#header").load("header.html");
	$("#nav").load("nav.html");
	$("#sidebar").load("sidebar.html");
	var $table = $("#dtsource");
	var data;
	var index = 1;
	fentch();
	var currentdtsid;

	axios.get('http://localhost/user/getCurrentUser').then((response) => {
		var result = response.data.message;
		if (result == 'Success') {
			var user = response.data.data;
			$(".username").text(user.username);
		} else {
			alert(response.data.data);
			window.location.href = "login.html";
		}
	});


	$(document).on("click", "#logout", function() {
		window.location.href = "login.html";
		$.removeCookie('token');
	});

	let isPinyin = false
	let inputText = ''
	let id = null

	document.querySelector('#search').addEventListener('compositionstart', function(evt) {
		isPinyin = true
	})


	document.querySelector('#search').addEventListener('compositionend', function(evt) {
		isPinyin = false
	})

	document.querySelector('#search').addEventListener('input', function(evt) {
		if (id) clearTimeout(id)
		id = setTimeout(() => { // 使用延时函数是因为compositionend比input触发慢，isPinyin未设置为false，input就已经执行了
			if (!isPinyin) {
				var searchList = data.filter(function(item) {
					if (item.dtSourceName.indexOf(evt.target.value) != -1) {
						return true;
					}
				});
				$table.empty();
				index = 1;
				for (i = 0; i < searchList.length; i++) {
					var $tr = $("<tr>" +
						"<td>" + index++ + "</td>" +
						"<td class='dtsName'>" + "<a href='javascript:updatedts(" + searchList[i].id +
						")' style='color: #007bff;'>" + searchList[i].dtSourceName + "</a></td>" +
						"<td>" + searchList[i].dtSourceType + "</td>" +
						"<td>" + searchList[i].createTime + "</td>" +
						"<td><a href='javascript:testdts(" + searchList[i].id +
						")' style='color: #007bff;'>测试</a> &nbsp;<a href='javascript:deletedts(" + searchList[i].id +
						")' style='color: #007bff;'>删除</a></td>" +
						"</tr>");
					$table.append($tr);
				}
			}
		}, 0)
	})



	function fentch() {
		$table.empty();
		axios.get('http://localhost/dtsource/findAll').then((response) => {
			var result = response.data.message;
			data = response.data.data;
			if (result == 'Success') {
				for (i = 0; i < data.length; i++) {
					var $tr = $("<tr>" +
						"<td>" + index++ + "</td>" +
						"<td class='dtsName'>" + "<a href='javascript:updatedts(" + data[i].id +
						")' style='color: #007bff;'>" + data[i].dtSourceName + "</a></td>" +
						"<td>" + data[i].dtSourceType + "</td>" +
						"<td>" + data[i].createTime + "</td>" +
						"<td><a href='javascript:testdts(" + data[i].id +
						")' style='color: #007bff;'>测试</a> &nbsp;<a href='javascript:deletedts(" + data[i].id +
						")' style='color: #007bff;'>删除</a></td>" +
						"</tr>");
					$table.append($tr);
				}

			} else {

			}
		});

	}


	function updatedts(id) {
		$("#title").text('修改数据源');
		$("#listdts").css('display', 'none');
		$("#createdts").css('display', '');
		$('#create').css('display', 'none');
		$('#update').css('display', '');
		currentdtsid = id;
		axios.get('http://localhost/dtsource/getDtSourceById?id=' + id).then((response) => {
			var result = response.data.message;
			var data = response.data.data;
			var dtSourceJson = jQuery.parseJSON(data.dtSourceJson);
			if (result == 'Success') {
				$('#dataSourceName').val(data.dtSourceName);
				$('#dataSourceType').val(data.dtSourceType);
				$('#accessKey').val(dtSourceJson.accessKey);
				$('#accessSecret').val(dtSourceJson.accessSecret);
				$('#region').val(dtSourceJson.region);
			} else {
				alert('操作失败，请重试');
			}
		});
	}


	$('#update').click(function() {
		var dataSourceName = $('#dataSourceName').val();
		var dataSourceType = $('#dataSourceType').val();
		var accessKey = $('#accessKey').val();
		var accessSecret = $('#accessSecret').val();
		var region = $('#region').val();
		if (dataSourceName == undefined || dataSourceName.trim() == '') {
			return true;
		} else if (dataSourceType == undefined || dataSourceType.trim() == '') {
			return true;
		} else if (accessKey == undefined || accessKey.trim() == '') {
			return true;
		} else if (accessSecret == undefined || accessSecret.trim() == '') {
			return true;
		} else if (region == undefined || region.trim() == '') {
			return true;
		}
		axios.post('http://localhost/dtsource/update', {
			id: currentdtsid,
			dataSourceName: dataSourceName,
			dataSourceType: dataSourceType,
			secretId: accessKey,
			secretKey: accessSecret,
			region: region,
		}).then((response) => {
			var result = response.data.message;
			if (result == 'Success') {
				$("#listdts").css('display', '');
				$("#createdts").css('display', 'none');
				window.location.href = 'datasource.html'
			} else {
				alert('修改失败');
			}
		});
	})



	function testdts(id) {
		axios.post('http://localhost/dtsource/connection', {
			id: id,
		}).then((response) => {
			var result = response.data.message;
			if (result == 'Success') {
				$('#resultMessgae').text('连接成功 └(^o^)┘').css({
					color: 'green'
				});
				$('#resultModal').modal('show');
			} else {
				$('#resultMessgae').text('连接失败X﹏X').css({
					color: 'red'
				})
				$('#resultModal').modal('show');
			}
		});
	}

	function deletedts(id) {
		//发删除请求
		axios.delete('http://localhost/dtsource/delete', {
			data: {
				id: id,
			}
		}).then((response) => {
			var result = response.data.message;
			if (result == 'Success') {
				$('#resultMessgae').text('删除成功 └(^o^)┘').css({
					color: 'green'
				});
				$('#resultModal').modal('show');
				fentch();
			} else {
				$('#resultMessgae').text('删除失败X﹏X').css({
					color: 'red'
				})
				$('#resultModal').modal('show');
			}
		});
	}

	$('#toCreate').click(function() {
		$("#listdts").css('display', 'none');
		$("#createdts").css('display', '');
	});

	$('#quit').click(function() {
		$("#listdts").css('display', '');
		$("#createdts").css('display', 'none');
	});


	(function() {
		'use strict';
		window.addEventListener('load', function() {
			var forms = document.getElementsByClassName('needs-validation');
			var validation = Array.prototype.filter.call(forms, function(form) {
				form.addEventListener('submit', function(event) {
					if (form.checkValidity() === false) {
						event.preventDefault();
						event.stopPropagation();
					}
					form.classList.add('was-validated');
				}, false);
			});
		}, false);
	})();

	$('#create').click(function() {
		var dataSourceName = $('#dataSourceName').val();
		var dataSourceType = $('#dataSourceType').val();
		var accessKey = $('#accessKey').val();
		var accessSecret = $('#accessSecret').val();
		var region = $('#region').val();
		if (dataSourceName == undefined || dataSourceName.trim() == '') {
			return true;
		} else if (dataSourceType == undefined || dataSourceType.trim() == '') {
			return true;
		} else if (accessKey == undefined || accessKey.trim() == '') {
			return true;
		} else if (accessSecret == undefined || accessSecret.trim() == '') {
			return true;
		} else if (region == undefined || region.trim() == '') {
			return true;
		}
		axios.post('http://localhost/dtsource/create', {
			dataSourceName: dataSourceName,
			dataSourceType: dataSourceType,
			secretId: accessKey,
			secretKey: accessSecret,
			region: region,
		}).then((response) => {
			var result = response.data.message;
			if (result == 'Success') {
				$("#listdts").css('display', '');
				$("#createdts").css('display', 'none');
				window.location.href = 'datasource.html'
			} else {
				alert(response.data.data);
			}
		});

	});


	$('#test').click(function() {
		var dataSourceName = $('#dataSourceName').val();
		var dataSourceType = $('#dataSourceType').val();
		var accessKey = $('#accessKey').val();
		var accessSecret = $('#accessSecret').val();
		var region = $('#region').val();

		if (dataSourceName == undefined || dataSourceName.trim() == '') {
			return true;
		} else if (dataSourceType == undefined || dataSourceType.trim() == '') {
			return true;
		} else if (accessKey == undefined || accessKey.trim() == '') {
			return true;
		} else if (accessSecret == undefined || accessSecret.trim() == '') {
			return true;
		} else if (region == undefined || region.trim() == '') {
			return true;
		}
		axios.post('http://localhost/dtsource/testconnection', {
			secretId: accessKey,
			secretKey: accessSecret,
			region: region,
		}).then((response) => {
			var result = response.data.message;
			if (result == 'Success') {
				$('#resultMessgae').text('连接成功 └(^o^)┘').css({
					color: 'green'
				});
				$('#resultModal').modal('show');
			} else {
				$('#resultMessgae').text('连接失败X﹏X').css({
					color: 'red'
				})
				$('#resultModal').modal('show');
			}
		});
	})
</script>
